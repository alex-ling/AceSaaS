@page
@inherits Acesoft.Web.UI.RazorPages.WebPage
@{
    ViewData["Title"] = "设备入库";
    Layout = "_shared/body";

    Ace.Layout().Fit().Items(lay =>
    {
        lay.Add().Region(Region.west).Border(false).Split().MinWidth(200).Width(250).MaxWidth(300).Controls(wst =>
        {
            Ace.Layout().AppendTo(wst).Fit().Items(layout =>
            {
                layout.Add().Css("oy").Region(Region.center).Controls(ctls =>
                {
                    Ace.Tree().AppendTo(ctls).Id("tree").Root("产品分类")
                        .DataSource("iot.product").Ajax(ds => ds.HttpGet())
                        .Events(e => e.OnSelect("onSelect"));
                });
            });
        });

        lay.Add().Region(Region.center).Border(false).Controls(cnt =>
        {
            Ace.Layout().AppendTo(cnt).Fit().Items(layout =>
            {
                layout.Add().Border().Region(Region.north).Height(44).Controls(ctls =>
                {
                    Ace.Search().Id("search").AppendTo(ctls).For("grid").Controls(query =>
                    {
                        Ace.TextBox().Name("keyword").AppendTo(query).Label("关键字：");
                        Ace.ComboBox().Name("sbzt").AppendTo(query).Label("　状态：").Width(130).Ajax(ds => ds.Dict("SBZT").NullSelect().HttpGet());
                    })
                    .Tools(tools =>
                    {
                        Ace.Button().AppendTo(tools).Text("批量注册").IconCls("fa fa-plus").Click("batchAdd()");
                        Ace.Button().AppendTo(tools).Text("单个注册").IconCls("fa fa-plus").Click("gridAdd('')");
                        Ace.Button().AppendTo(tools).Text("删除").IconCls("fa fa-remove").Click("gridDel()");
                    });
                });
                layout.Add().Border(false).Region(Region.center).Controls(ctls =>
                {
                    Ace.DataGrid().Id("grid").AppendTo(ctls).Pagination().Export()
                    .DataSource("iot.devregist").Ajax(ds => ds.HttpGet())
                    .Delete("iot/delete", "iot.device").Columns(c =>
                    {
                        c.Add().Field("sbno").Title("设备编号").Width(5);
                        c.Add().Field("mac").Title("MAC地址").Width(5);
                        c.Add().Field("cpxh").Title("设备型号").Width(5);
                        c.Add().Field("sbzt_name").Title("设备状态");
                        c.Add().Field("rkrq").Title("入库日期").Width(5).Format("date:yyyy-MM-dd");
                        c.Add().Field("remark").Title("备注").Width(8);
                        c.Add().Field("action").Title("操作").Format("button");
                    });
                });
            });
        });
    }).Render();
}
<script>
    function onSelect(node) {
        var level = $('#tree').tree('getLevel', node.target);
        if (level == 3) $('#grid').datagrid('load', { _productid: node.id });
    }
    function gridAdd() {
        var node = $('#tree').tree('getLevel', 3);
        if (node != null) AX.gridAdd('#grid', AX.format('productid={0}&cpno={1}', node.id, node.text.split('.')[0]));
    }
    function batchAdd() {
        var node = $('#tree').tree('getLevel', 3);
        if (node != null) {            
            AX.dialog('批量注册', 'import?' + AX.format('productid={0}&cpno={1}', node.id, node.text.split('.')[0]), function () {
                $('#grid').datagrid('reload');
            });
        }
    }
    function event_grid_iotdel(cid, id) {
        var row = $('#grid').datagrid('getRow', id);
        AX.gridDel('#grid', row.mac);
    }
    function gridDel() {
        var macs = $('#grid').datagrid('getCheckedId', 'mac');
        AX.gridDel('#grid', macs);
    }
</script>